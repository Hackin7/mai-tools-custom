(()=>{"use strict";!function(e){const i=new Map([["S","/maimai-mobile/maimai-img/icon_s.png"],["S+","/maimai-mobile/maimai-img/icon_s_plus.png"],["SS","/maimai-mobile/maimai-img/icon_ss.png"],["SS+","/maimai-mobile/maimai-img/icon_ss_plus.png"],["SSS","/maimai-mobile/maimai-img/icon_sss.png"],["SSS+","/maimai-mobile/maimai-img/icon_sss_plus.png"]]),n=new Map([["AAA","/maimai-mobile/img/music_icon_aaa.png"],["AA","/maimai-mobile/img/music_icon_aa.png"],["A","/maimai-mobile/img/music_icon_a.png"]]),o=new Map([["fc","/maimai-mobile/maimai-img/icon_fc_silver.png"],["fcplus","/maimai-mobile/maimai-img/icon_fc_gold.png"],["ap","/maimai-mobile/maimai-img/icon_ap.png"]]),t=new Map([["applus","/maimai-mobile/img/music_icon_app.png"]]),a=new Map([["FS","/maimai-mobile/maimai-img/icon_maxfever_silver.png"],["FS+","/maimai-mobile/maimai-img/icon_maxfever_gold.png"]]),m=new Map([["FDX","/maimai-mobile/img/music_icon_fsd.png"],["FDX+","/maimai-mobile/img/music_icon_fsdp.png"]]);function s(e){return e.trim().replace(/\s+/g,"-")}function c(e,i){return i=i||2,e.toString().padStart(i,"0")}function r(e,i){let n=e.get(i);return n instanceof Blob?Promise.resolve(n):n?fetch(n).then((e=>e.blob())).then((n=>(e.set(i,n),n))):void 0}function l(i){const n=i.querySelector("img.music_img"),o=e.createElement("canvas");return o.width=n.width,o.height=n.height,o.getContext("2d").drawImage(n,0,0,o.width,o.height),o.toDataURL()}function g(e){return r(i,e)||r(n,e)||Promise.reject('invalid title "'+e+'"')}function p(e){const i=e.querySelector(".playlog_result_innerblock > img:nth-child(3)").src;switch(i.substring(i.lastIndexOf("/")+1,i.lastIndexOf("."))){case"fs":return"FS";case"fsplus":return"FS+";case"fsd":return"FDX";case"fsdplus":return"FDX+"}return null}if(("maimaidx-eng.com"===e.location.host||"maimaidx.jp"===e.location.host)&&e.location.pathname.includes("/maimai-mobile/record/playlogDetail/")){let i="https://myjian.github.io/mai-tools/classic-layout/?st="+encodeURIComponent(e.body.querySelector(".basic_block.break").childNodes[1].nodeValue)+"&ac="+encodeURIComponent(function(e){const i=e.querySelector(".playlog_achievement_txt").innerText;return i.substring(0,i.length-1)}(e.body))+"&nd="+encodeURIComponent(e.body.querySelector(".playlog_notes_detail").innerText.split("\n").slice(-5).map(s).join("_"))+"&df="+encodeURIComponent(function(e){const i=e.querySelector(".playlog_top_container img.playlog_diff").src,n=i.substring(i.lastIndexOf("_")+1,i.lastIndexOf("."));return"remaster"===n?"Re:MASTER":n.toUpperCase()}(e.body))+"&tk="+encodeURIComponent(function(e){return e.querySelector(".playlog_top_container .sub_title .f_b").innerText.replace("0","")}(e.body))+"&dt="+encodeURIComponent(function(e){const i=e.querySelector(".playlog_top_container .sub_title span:last-child").innerText.match(/(\d+)\/(\d+)\/(\d+) (\d+):(\d+)/),n=new Date(parseInt(i[1]),parseInt(i[2])-1,parseInt(i[3]),parseInt(i[4]),parseInt(i[5]));return(o=new Date(n.valueOf()-36e5)).getFullYear()+"-"+c(o.getMonth()+1)+"-"+c(o.getDate())+" "+c(o.getHours())+":"+c(o.getMinutes());var o}(e.body))+"&hs="+encodeURIComponent(function(e){return e.querySelector(".playlog_achievement_newrecord")?1:0}(e.body))+"&cb="+encodeURIComponent(function(e){return e.querySelector(".col2 .playlog_score_block .white").innerText}(e.body));const n=p(e.body);n&&(i+="&sc="+encodeURIComponent(n)),console.log(i),console.log("url length: "+i.length),window.open(i,"_blank"),window.addEventListener("message",(i=>{if("https://myjian.github.io"===i.origin||"https://cdpn.io"===i.origin){const s=i.data,c=i.source;let u="";switch(s.action){case"ready":c.postMessage({action:"songImage",imgSrc:l(e.body)},i.origin),function(e){const i=e.querySelector(".playlog_result_innerblock > img:nth-child(2)").src,n=i.substring(i.lastIndexOf("/")+1,i.lastIndexOf("."));return"fc_dummy"===n?Promise.resolve(null):r(o,n)||r(t,n)||Promise.reject('invalid title "'+n+'"')}(e.body).then((e=>{e&&c.postMessage({action:"apFcImage",img:e},i.origin)})),(n=p(e.body),n?r(a,n)||r(m,n)||Promise.reject('invalid title "'+n+'"'):Promise.resolve(null)).then((e=>{e&&c.postMessage({action:"syncImage",img:e},i.origin)})),u=function(e){const i=e.querySelector(".playlog_scorerank").src;return i.substring(i.lastIndexOf("/")+1,i.lastIndexOf(".")).toUpperCase().replace("PLUS","+")}(e.body),g(u).then((e=>{c.postMessage({action:"rankImage",title:u,img:e},i.origin)}));break;case"getRankImage":u=s.payload,g(u).then((e=>{c.postMessage({action:"rankImage",title:u,img:e},i.origin)}))}}var n}))}}(document)})();